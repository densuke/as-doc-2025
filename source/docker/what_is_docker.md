# そもそもDockerとはなんだったのか?

## プロセスとは

LinuxでもWindowsでも(そしてAndroidやiOSでも)、OSはアプリケーションを管理するための方法として、プロセスを使っています。

- プロセスは(主に)プログラムをもととした実行の単位です。
- プロセスはOSが管理するリソースの単位です。
- プロセスはマルチタスクにおいて、それぞれが独立して実行されます。
- プロセスの管理はOSの仕事です。

一般的にマルチタスク環境において、プロセス実行時は『自分のプロセスのメモリ』しか見えないようになっています。下手に他のプロセスのメモリを見せると誤って書き込んで破壊される恐れもあるからです。

## プロセスの可視性

プロセスはお互いに干渉しないように設計されていますが、プロセスの中で動いているアプリケーションは、他のプロセスの情報を知りたくなることがあります。
たとえば、あるプロセスが他のプロセスの状態を知りたい場合、OSに問い合わせて情報を取得することができます。これを「プロセス間通信」と呼びます。
逆に言えば、この方法以外でプロセスの情報を取得することはできません。

実際のところ、プロセス間通信の手法はいくつかあります。

- シグナルも一種のプロセス間通信です。
- ソケット通信もプロセス間通信です。
- ファイルを作成して、他のプロセスに読み込ませることも一応プロセス間通信になりえます。
- 共有メモリを用いることによるプロセス間通信も可能です。
- その他いくつかの方法があります。

そういった手法を用いない限り、他のプロセスに干渉できないように保護されていますが、実はプロセスの存在自体は共有されています。

```bash
# Linuxでのプロセス一覧取得の例
$ ps aux
```

```pwsh
# Windowsでのプロセス一覧取得の例
PS C:\> Get-Process
```
上記のように、OSはプロセスの情報を取得するためのAPIを提供しています。これを利用することで、他のプロセスの情報を取得することができます。

## プロセスのリソース

プロセスはOSが管理するリソースの単位です。プロセスは、CPUやメモリ、ディスクなどのリソースを使用します。プロセスは、OSが管理するリソースを使用することで、アプリケーションを実行します。
少し言い換えると、OSはプロセスに対して各種のリソースを適切に提供し、それ以外は見せないようなアプローチを取っています。
とはいえ、OS上のプロセスで共有しているものも存在します。

- プロセスの存在自体は共有されています(`ps`で見えたのはそれ)。
- ストレージは共有されています。
- ネットワークは共有されています。
- 一部のメモリは共有されています(いわゆる共有メモリ)。

## リソースの分離

ここまでのことから、他のプロセスやリソースが共有できる状態だと、それらを通じて他にちょっかいを出すことが可能とも考えられます。
そこで、OS側で少し手を加えてリソースに対する『分離』を提供することが研究されました。

- chroot
    - プロセスをを特定のディレクトリに納めることができるようになる
    - 対象プロセス(および子プロセス)は、chrootで指定したディレクトリの中しか見えない
    - POSIX系のOSであれば、chrootはほぼ全てのOSで利用可能
- FreeBSD Jail
    - FreeBSD Jailは、FreeBSDのchrootを拡張したもの
    - プロセスを特定のディレクトリに納めることができるようになる
    - 対象プロセス(および子プロセス)は、chrootで指定したディレクトリの中しか見えない
    - 対象プロセス(および子プロセス)は、FreeBSD Jailで指定したネットワークインターフェースしか見えない
    - FreeBSD Jailは、FreeBSDのOSにしか存在しない
- Linux Namespace
    - Linux Namespaceは、Linuxのchrootを拡張したもの
    - プロセスを特定のディレクトリに納めることができるようになる
    - 対象プロセス(および子プロセス)は、chrootで指定したディレクトリの中しか見えない
    - 対象プロセス(および子プロセス)は、Linux Namespaceで指定したネットワークインターフェースしか見えない
    - Linux Namespaceは、LinuxのOSにしか存在しない
- KVM(Kernel-based Virtual Machine)
    - Linuxの仮想マシン機構で、カーネルに組み込まれている
    - KVMの機能を用いて、親元のマシン情報を隠して仮想マシンを持たせることができる
        - 仮想マシンはホスト側のリソースの一部を制限して渡すことができる
- Hyper-V(Microsoft)
    - Windowsの仮想マシン機構で、カーネルに組み込まれている
    - Hyper-Vの機能を用いて、親元のマシン情報を隠して仮想マシンを持たせることができる
        - 仮想マシンはホスト側のリソースの一部を制限して渡すことができる
    - WSL(Windows Subsystem for Linux)は、Hyper-Vを利用してLinuxの仮想マシンを持たせることができる
- WSL(Windows Subsystem for Linux)
    - Hyper-Vの仕組みを利用して、LinuxをWindows上で走らせている
    - 内部的にはWSL1とWSL2が公開されており、現在はWSL2が主流
        - WSL1は、LinuxのカーネルをWindows上でエミュレートしている
        - WSL2は、LinuxのカーネルをWindows上で仮想化している
    - WSL2は本来、Windows10/11のPro以上でしか使えないが、Windows11のバージョンアップに伴い、Windows11 Homeでも利用可能になった(仮想マシンプラットフォームによる制限されたHyper-V)

## Dockerの登場

Dockerは、LinuxのNamespaceとcgroupを利用して、プロセスを分離することができるようにしたものです。

- プロセスのためのファイルシステム空間を用意する
- プロセスのためのネットワーク空間を用意する
- これらにNamespaceによる縛りを設けて、その中でプロセスを走らせると、外側になる他プロセスは見えなくなる
- さらにcgroupを用いて、プロセスのリソースに制限を個別に持たせる

これらの仕組みをまとめた製品として、Dockerが登場しました。