# 仮想マシンについて

別アプローチとして、仮想マシン(VM; Virtual Machine)というアプローチがあります。

## 仮想マシン(VM)とは

VMは実行環境(機械)を仮想化することで、OSを仮想化して提供します。

- VMはCPUやメモリ、ストレージなどを仮想化します
- その結果VMの中でOSを起動することができます
- VMをひとつのかたまりとしてリソースの分離が行われます
- VM内のOS(とプロセス)がリソースを必要とするとき、必要であれば起動元(ホスト)にアクセスします

一般的なVMとしては、性能のトレードオフとして、以下の形式で動きます。
- CPUはホストと同じものを提供する
    - x86_64系CPU上のVMはx86_64系CPUを提供する
    - ARM系CPU上のVMはARM系CPUを提供する
- メモリはホストのメモリをそのまま提供する
    - VMはホスト(= VMのプロセスの確保した)のメモリをそのまま使う
- ストレージは主にホスト上でファイルを作成し、ディスクデバイスにみせかける
    - 場合によってはストレージを直接見せることもありますが、レアケース
- ネットワークはいくつかの方法が用意されていることが多い
    - VMがホストのネットワークデバイスをブリッジして同じネットワークにあるように見せるケース
    - VMがホストのネットワークデバイスをNATして、VMの中からホストにアクセスするケース
        - VMから外へのアクセスはできるが、VMへのアクセスに制限が入る
        - 一般的なVMはこの使い方が大半
        - 必要なら穴開けをする

## VMの構造的分類

VMは大きく分けて2つの種類があります。

### Type-1 VM(Hypervisor)

Type-1 VMは、ホストOSの下で動くVMです。

- 通常のOSはハードウェアの直下で動くイメージです
- Type-1 VMはハードウェア直下に **ハイパーバイザー**(HV; HyperVisor)という層を組み込みます
- HVがVMホストとなり、その上でOSを動かします
- OSがリソースを要求するとき、その要求をHVが奪い取って制御することになります
- 実装方法は大きく二つ存在します
  - HVがOSの下で動く
    - VMware ESXi
    - Xen(完全仮想化モード)
  - HVがOSに組み込まれている
    - Microsoft Hyper-V
    - Xen(準仮想化モード)
    - KVM
- 効率よく動くためには、CPUレベルでの仮想化支援機能が必要とされます
  - Intel VT-x
  - AMD-V

### Type-2 VM(Hosted VM)
Type-2 VMは、ホストOSの上で動くVMです。

- 一般的にアプリケーションの形で動きます
- Type-1に比べると導入が容易です
- 性能はType-1と比べると劣ります
- その気になれば別のアーキテクチャのシミュレーションも可能です
    - 例えば、ARMアーキテクチャのシミュレーションが可能です
    - ただし、性能は実際のハードウェアに依存します
- AppleのmacOS上ではRosetta2というVM機構を提供することで、x86_64向けのmacOSアプリケーションを動かすことができるようになっています
- 実装例
    - VMware Workstation
    - Oracle VirtualBox
    - QEMU
    - Parallels Desktop
    - Microsoft Virtual PC(現在は存在しません)

## Dockerの構造

DockerはLinuxでしか動きません(LinuxのNamespaceとcgroupを利用しているため)。
そのため、Docker Desktop等では、VMを用意してLinuxを走らせ、その中でDockerを提供しています。

- Windows版ではWSL2を用いてLinux環境を構築し、その中でDockerを動かしている
- macOS版ではHyperKitを用いてLinux環境を構築し、その中でDockerを動かしている

このような仕組みを提供するため、Dockerはクライアント・サーバー構造で動くようになっています。

- Docker Client
    - Dockerのコマンドを実行するためのクライアント
    - Dockerのサーバー(Engine)に対してネットワーク的にコマンドを送受ししている
- DOcker Server(Engine)
    - Dockerのコマンドを実行するためのサーバー
    - Dockerのクライアントからのコマンドを受け取り、実行する
    - Dockerのイメージやコンテナを管理する
    - Dockerのイメージやコンテナを管理するために、Docker Daemonというプロセスを起動している

そのため、仕組みを理解していると、ローカルのDocker clientからリモートのDocker Engineを叩くことも可能です。

```{note}
DockerはVM上で構成された低レベルなLinux(Docker Engineを走らせるのに必要となる最低限レベル)が稼働している状態です。

2年生時のLinuxでは、この環境の中で基本的な機能を持つLinuxを構築することで授業時に利用していました。
```
